name: Update App Catalog

on:
  # Triggered by other repos via repository_dispatch
  repository_dispatch:
    types: [app-updated]

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      app_id:
        description: 'App ID to update (e.g. rom-nav-stack)'
        required: false
      version:
        description: 'New version string'
        required: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  update-and-deploy:
    name: Update catalog & deploy
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update app entry (if payload provided)
        if: github.event.client_payload.app_id != ''
        run: |
          APP_ID="${{ github.event.client_payload.app_id }}"
          VERSION="${{ github.event.client_payload.version }}"
          STATUS="${{ github.event.client_payload.status }}"
          TODAY=$(date -u +"%Y-%m-%d")

          echo "Updating $APP_ID â†’ v$VERSION ($STATUS) on $TODAY"

          # Update version
          if [ -n "$VERSION" ]; then
            jq --arg id "$APP_ID" --arg ver "$VERSION" \
              '(.apps[] | select(.id == $id)).version = $ver' \
              data/apps.json > tmp.json && mv tmp.json data/apps.json
          fi

          # Update status
          if [ -n "$STATUS" ]; then
            jq --arg id "$APP_ID" --arg st "$STATUS" \
              '(.apps[] | select(.id == $id)).status = $st' \
              data/apps.json > tmp.json && mv tmp.json data/apps.json
          fi

          # Update date
          jq --arg id "$APP_ID" --arg d "$TODAY" \
            '(.apps[] | select(.id == $id)).updatedAt = $d | .lastUpdated = $d' \
            data/apps.json > tmp.json && mv tmp.json data/apps.json

      - name: Commit changes
        if: github.event.client_payload.app_id != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/apps.json
          git diff --cached --quiet || git commit -m "chore: update ${{ github.event.client_payload.app_id }} to ${{ github.event.client_payload.version }}"
          git push

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
